--- ../src-base/minecraft/net/minecraft/entity/player/EntityPlayerMP.java
+++ ../src-work/minecraft/net/minecraft/entity/player/EntityPlayerMP.java
@@ -114,6 +114,16 @@
 import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
 
+import carpet.CarpetSettings;
+import carpet.helpers.EntityPlayerActionPack;
+import carpet.helpers.IPlayerSensitiveTileEntity;
+import carpet.logging.logHelpers.DamageReporter;
+import net.minecraft.entity.item.EntityMinecart;
+import net.minecraft.entity.passive.EntityLlama;
+import net.minecraft.entity.monster.EntityCreeper;
+import net.minecraft.nbt.JsonToNBT;
+import net.minecraft.nbt.NBTException;
+
 public class EntityPlayerMP extends EntityPlayer implements IContainerListener
 {
     private static final Logger field_147102_bM = LogManager.getLogger();
@@ -153,6 +163,10 @@
     public int field_71138_i;
     public boolean field_71136_j;
 
+    //CM
+    //CM
+    public EntityPlayerActionPack actionPack = new EntityPlayerActionPack(this);
+
     public EntityPlayerMP(MinecraftServer p_i45285_1_, WorldServer p_i45285_2_, GameProfile p_i45285_3_, PlayerInteractionManager p_i45285_4_)
     {
         super(p_i45285_2_, p_i45285_3_);
@@ -313,6 +327,9 @@
 
     public void func_70071_h_()
     {
+        //CM
+        actionPack.onUpdate();
+        //CM end
         this.field_71134_c.func_73075_a();
         --this.field_147101_bU;
 
@@ -365,6 +382,13 @@
             }
         }
 
+        if (CarpetSettings.ridingPlayerUpdateFix) {
+            Entity riding = func_184208_bv();
+            if(riding != null && (riding instanceof EntityMinecart || riding instanceof EntityLlama)){
+                this.field_71133_b.func_184103_al().func_72358_d(this);
+            }
+        }
+
         CriteriaTriggers.field_193135_v.func_193182_a(this);
 
         if (this.field_193107_ct != null)
@@ -503,6 +527,34 @@
             this.field_71071_by.func_70436_m();
         }
 
+        // Allows players to drop there skulls when blown up by charged creeper CARPET-XCOM
+        if (CarpetSettings.playerSkullsByChargedCreeper)
+        {
+            Entity entity = p_70645_1_.func_76346_g();
+            
+            if (entity instanceof EntityCreeper)
+            {
+                EntityCreeper entitycreeper = (EntityCreeper) entity;
+                
+                if (entitycreeper.func_70830_n() && entitycreeper.func_70650_aV())
+                {
+                    entitycreeper.func_175493_co();
+                    
+                    try
+                    {
+                        ItemStack playerskull = new ItemStack(Items.field_151144_bL, 1, 3);
+                        playerskull.func_77982_d(JsonToNBT.func_180713_a(String.format("{SkullOwner:\"%s\"}", func_70005_c_().toLowerCase())));
+                        this.func_70099_a(playerskull, 0.0F);
+                    }
+                    catch (NBTException e)
+                    {
+                        e.printStackTrace();
+                    }
+                }
+            }
+        }
+        // CM
+
         for (ScoreObjective scoreobjective : this.field_70170_p.func_96441_U().func_96520_a(IScoreCriteria.field_96642_c))
         {
             Score score = this.func_96123_co().func_96529_a(this.func_70005_c_(), scoreobjective);
@@ -605,6 +657,7 @@
 
             if (!flag && this.field_147101_bU > 0 && p_70097_1_ != DamageSource.field_76380_i)
             {
+                DamageReporter.modify_damage(this, p_70097_1_, p_70097_2_, 0.0F, "respawn protection");
                 return false;
             }
             else
@@ -615,6 +668,7 @@
 
                     if (entity instanceof EntityPlayer && !this.func_96122_a((EntityPlayer)entity))
                     {
+                        DamageReporter.modify_damage(this, p_70097_1_, p_70097_2_, 0.0F, "PVP disabled");
                         return false;
                     }
 
@@ -624,6 +678,7 @@
 
                         if (entityarrow.field_70250_c instanceof EntityPlayer && !this.func_96122_a((EntityPlayer)entityarrow.field_70250_c))
                         {
+                            DamageReporter.modify_damage(this, p_70097_1_, p_70097_2_, 0.0F, "PVP disabled");
                             return false;
                         }
                     }
@@ -704,6 +759,8 @@
         if (p_147097_1_ != null)
         {
             SPacketUpdateTileEntity spacketupdatetileentity = p_147097_1_.func_189518_D_();
+            if (p_147097_1_ instanceof IPlayerSensitiveTileEntity)
+                spacketupdatetileentity = ((IPlayerSensitiveTileEntity) p_147097_1_).getUpdatePacketPlayerSensitive(this);
 
             if (spacketupdatetileentity != null)
             {
@@ -1216,11 +1273,13 @@
 
         if (p_71033_1_ == GameType.SPECTATOR)
         {
+            if(CarpetSettings.spectatorsDontLoadChunks) ((WorldServer)field_70170_p).func_184164_w().func_72695_c(this);
             this.func_192030_dh();
             this.func_184210_p();
         }
         else
         {
+            if(CarpetSettings.spectatorsDontLoadChunks) ((WorldServer)field_70170_p).func_184164_w().func_72683_a(this);
             this.func_175399_e(this);
         }
 
